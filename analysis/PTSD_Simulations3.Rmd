---
title: "PTSD Model, Simulation 3 Analysis"
author: "Andrea Stocco"
date: "January 10, 2020"
output:
  html_document:
    code_folding: hide
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(scales)
```

# PTSD Model: Analysis of Simulation 3

## Loading the Data

The raw simulations are stored in a large datafile. An aggregated version of the dataset exist.

```{r loading, echo=FALSE, error=FALSE}
d <- read_csv("simulations3.csv", col_types = cols())
d <- d %>%
  mutate(Day = floor(Time / (60*60*24)) - 100,
         Hour = floor((d$Time / 3600) %% 24),
         RuminationFrequency=as_factor(RuminationFrequency))
names(d)[18] <- "W"
```

### Distribution of events

First, let's check that the distribution of events over time (as approximated by retrieval times) follow a gamma distribution, as intended:

```{r barplot}
#ggplot(d, aes(x=Hour)) +
#  geom_histogram(binwidth = 1, col="white", alpha=0.5, position="identity") +
#  theme_pander()

ggplot(d, aes(x=Hour, fill=RuminationFrequency)) +
  geom_histogram(binwidth = 1, col="white", alpha=0.5, position="identity") +
  theme_pander()
```

### Simplify and Aggregate the Data

The full data from Simulation 3 is way too large to handle (14G, containing `r dim(d)[1]` obserbations of `r dim(d)[2]` variables). So we need to reduce it and simplify it.

We begin by removing most of the days preceding the PTE:

```{r}
d <- d %>% 
  dplyr::select(Run, Day, PTEV, Gamma, PTES, W, 
         NumAttributes, RuminationFrequency, 
         MemoryEntropy, ChunkSimilarity, Traumatic) %>%
  filter(Day > -20)
```

We then turn the various variables into factors, so that they can be grouped efficiently:

```{r mutating}
d <- d %>%
  mutate(#RT = as_factor(RT), 
    Gamma=as_factor(Gamma),
    #RuminationFrequency=as_factor(RuminationFrequency),
    #ANS = as_factor(ANS),
    W=as_factor(W),
    PTES = as_factor(PTES),
    PTEV = as_factor(PTEV),
    NumAttributes = as_factor(NumAttributes))
```

After transforming the dataset, we aggregate the data:

```{r summarizing}
# Reduce, summarizing across events 
a <- d %>% 
  group_by(Day, PTES, PTEV, Run, 
           Gamma, W, RuminationFrequency, 
           NumAttributes) %>% 
  summarize_all(mean) 
```

And then we select the variables of interest, sorting the rows so that, for each run, the days are in ascending order.

```{r sorting}
a <- a %>% ungroup %>% mutate(PTEV = as_factor(PTEV),
                              A = as_factor(NumAttributes))

a <- a %>% select(Run, Day, PTEV, Gamma, PTES, W, 
                  NumAttributes, RuminationFrequency, 
                  MemoryEntropy, ChunkSimilarity, Traumatic)

a <- a %>% arrange(Run, PTEV, PTES, PTES, NumAttributes, 
                   RuminationFrequency, W, Gamma)

```


## Categorizing Recovery Trajectories

According to many influential reviews, the recovery trajectories fro PTSD can be grouped into four categories:

  1. Chronic response
  2. Delayed response
  3. Spontaneous recovery
  4. Resilience
  
These four curves can e easily identified by comparing the number of intrusive memories before vs. immediately after the PTE, first, and immediately after the PTE vs. after two months, second.

To examine the composition of recovery trajectories across simulation parameters, we first need to create a funcion that properly classifies an individual trajectory:

```{r}
# Classifies people based on trajectory:
# Chronic = 1
# Recovery =2
# Delay    =3
# resilient= 4
#
classify <- function(days) {
  g1 <- days[10:19]
  g2 <- days[21:30]
  g3 <- days[70:79]
  t12 <- t.test(g1, g2)
  t23 <- t.test(g2, g3)
  category <- 0
  if (!is.na(t12$p.value) & t12$p.value < 0.05) {
    # t1 < t2
    if (!is.na(t23$p.value) & t23$p.value < 0.05) {
      # t2 <> t3
      
      if (!is.na(t23$statistic) & t23$statistic > 0) {
        # t1 < t2, t2 > 3
        category <- "Recovery" #2  # Recovery
      } else {
        # t1 < t2, t2 < t3
        category <- "Delayed" # 3 # Delayed
      } 
    } else {
      # t1 < t2, t2 = t3
      category <- "Chronic" # 1 # Chronic
    }
  } else {
    # t1 == t2
    if (!is.na(t23$p.value) & t23$p.value < 0.05) {
      # t1 == t2, t2 < t3
      category <- "Delayed" #3 # Delayed
    } else {
      # t1 == t2, t2 = t3
      category <- "Resilient" # 4 # Resilient
    }
  }
  category
}
```

We then proceed to summarize the data according to their category:

```{r}
patterns <- a %>% 
  group_by(Run, PTEV, PTES, NumAttributes, RuminationFrequency, W, Gamma) %>%
  summarize(Trajectory = classify(Traumatic)) 
```


## Results

### Behavioral Data

For each variable of interest, we are going to examine two forms of behavioral data:

 1. The average recovery trajectory, which indicates the probability of retrieving a traumatic memory over the number of days after the PTE; and
 2. The distribution of recovery trajectories, that is, the percentages at which each of the four main trajectories occurs in the data.  

### General Results

The two main parameters that affect the retrieval probability in the model are the intensity of the PTE (_PTEV_) and the vividness of memory recollection (_gamma_). First, we need to check whether there is an effect of Gamma (intensity of memory) and PTEV (intensity of event). Thus, we will first examine the general effects of these two variables on both of our dependent measures.

```{r}
ggplot(data=a,
       aes(x=Day, y=Traumatic)) +
  stat_summary(fun.data = mean_se, geom="line") +
  stat_summary(fun.data = mean_se, geom="errorbar", alpha=0.5) +
  #stat_summary(fun.data = mean_se, geom="point") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  theme_pander() +
  ggtitle("Main Effects of Gamma and PTEV") +
  ylab("Probability of Retriving a Traumatic Memory") +
  annotate("rect", xmin=-2, xmax=2, ymin=-Inf, ymax=Inf, fill="red", alpha=0.2)
```

As expected, when PTEV = 1, there is no significant effect (the added value of a traumatic memory is zero). So, we can filter this value out in the following analysis

In addition to the mean recovery curves, we also want to assess the percentage of trajectories.

```{r fig.width=7, fig.height=7}

G_patterns <- patterns %>%
  group_by(PTEV, Gamma, Trajectory) %>%
  summarize(Num=n() / 24) %>%
  mutate(Val=cumsum(Num))

ggplot(data=filter(G_patterns, PTEV != 1), aes(x="", y=Num, fill=Trajectory)) +
  geom_bar(width=1, stat = "identity") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  coord_polar("y", start=0) +
  scale_fill_brewer(palette="Set3") +
  xlab("") +
  ylab("") +
  ggtitle("Percentage of Recovery Trajectories") +
  theme_pander()
```

### Effects of the Number of Attributes in a Memory

The number of attributes _A_ in a memory is a computational proxy for the level of precision that an individual has in encoding the perceptual representations of an event. It has been found that individuals whose representation has greater sensory details  (as indexed by mental imagery and perceptual priming) have worse outcomes from PTSD.   
This is reflected in our data, as show bt the higher curves corresponding to greater number of attributes (_A_ = 6 vs. _A_ = 4).

```{r}
ggplot(data=filter(a, PTEV != 1), 
       aes(x=Day, y=Traumatic, col=NumAttributes)) +
  stat_summary(fun.data = mean_se, geom="line") +
  stat_summary(fun.data = mean_se, geom="errorbar",alpha=0.5) +
  #stat_summary(fun.data = mean_se, geom="point") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  theme_pander() +
  ggtitle("Effect of Number of Attributes by Gamma and PTEV") +
  ylab("Probability of Retriving a Traumatic Memory") +
  annotate("rect", xmin=-2, xmax=2, ymin=-Inf, ymax=Inf, fill="blue", alpha=0.2)
```

In addition, we can also observe how the Number of Attributes per memory 

```{r}
A_patterns <- patterns %>%
  group_by(PTEV, Gamma, Trajectory, NumAttributes) %>%
  summarize(Num=n() / 12) %>%
  mutate(Val=cumsum(Num))

ggplot(data=filter(A_patterns, PTEV != 1), aes(x=NumAttributes, y=Num, fill=Trajectory)) +
  geom_bar(stat = "identity", position="stack", col="white") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  scale_fill_brewer(palette="Accent") +
  xlab("Number of Attributes (A)") +
  ylab("Percentage of Trajectories") +
  ggtitle("Percentage of Recovery Trajectories by Number of Attributes") +
  geom_text(aes(label=percent(Num/100)),
            position=position_stack(vjust=0.5)) +
  theme_pander()
```

### Effects of Working Memory Campaciy

It is known in the literature that Working Memory (and cognitive control, which is typically indexed by working memory tasks) is associated with better outcomes following PTSD. 

This is true in our simulations, as evidenced by the greater probability of retrieving traumatic memories as the value of working memory decreases (_W_ = 4 vs. 8 vs. 12).

```{r}
ggplot(data=filter(a, PTEV != 1),
       aes(x=Day, y=Traumatic, col=W)) +
  stat_summary(fun.data = mean_se, geom="line") +
  stat_summary(fun.data = mean_se, geom="errorbar", alpha=0.5) +
  facet_grid(PTEV ~ Gamma, labeller = label_both) +
  theme_pander() +
  ggtitle("Effect of Working Memory by Gamma and PTEV") +
  ylab("Probability of Retriving a Traumatic Memory") +
  annotate("rect", xmin=-2, xmax=2, ymin=-Inf, ymax=Inf, fill="red", alpha=0.2)
```

Working memory capacity also has profound effects on the trajectories:

```{r}
W_patterns <- patterns %>%
  group_by(PTEV, Gamma, Trajectory, W) %>%
  summarize(Num=n() / 8) %>%
  mutate(Val=cumsum(Num))

ggplot(data=filter(W_patterns, PTEV != 1), aes(x=W, y=Num, fill=Trajectory)) +
  geom_bar(stat = "identity", position="stack", col="white") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  scale_fill_brewer(palette="Accent") +
  xlab("Working Memory (W)") +
  ylab("Percentage of Trajectories") +
  ggtitle("Percentage of Recovery Trajectories by WOrking Memory") +
  geom_text(aes(label=percent(Num/100)),
            position=position_stack(vjust=0.5)) +
  theme_pander()
```

### Effect of Rumination and Negative Appraisal

We examined whether the tendency to ruminate or revisit the past traumatic experience (the PTE) negatively affects the model's performance. This is done by examining the effect of the numer of Spontaneous (i.e., not tied to event) Retrievals:


```{r}
ggplot(data=filter(a, PTEV != 1), 
       aes(x=Day, y=Traumatic, col=RuminationFrequency)) +
  stat_summary(fun.data = mean_se, geom="line") +
  stat_summary(fun.data = mean_se, geom="errorbar", alpha=0.5) +
  facet_grid(PTEV ~ Gamma, labeller = label_both) +
  theme_pander() +
  ylab("Probability of Retriving a Traumatic Memory") +
  ggtitle("Effect of Spontaneous Retrievals by Gamma and PTEV") +
  annotate("rect", xmin=-2, xmax=2, ymin=-Inf, ymax=Inf, fill="red", alpha=0.2)
```

And we can see the profound effects of spontaneous retrievals on recovery trajectories:

```{r}
R_patterns <- patterns %>%
  group_by(PTEV, Gamma, Trajectory, RuminationFrequency) %>%
  summarize(Num=n() / 12) %>%
  mutate(Val=cumsum(Num))

ggplot(data=filter(R_patterns, PTEV != 1), aes(x=RuminationFrequency, y=Num, fill=Trajectory)) +
  geom_bar(stat = "identity", position="stack", col="white") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  scale_fill_brewer(palette="Accent") +
  xlab("Number of Spontaneous Retrievals") +
  ylab("Percentage of Trajectories") +  
  ggtitle("Percentage of Recovery Trajectories by Number of Spontaneous Retrievals") +
  geom_text(aes(label=percent(Num/100)),
            position=position_stack(vjust=0.5)) +
  theme_pander()
```

### Effects of Congruency

Finally, the last factor we examined is the effect of the similarity or congruency __PTES__ between the PTE and the contextual events (_Q_). 

```{r}
ggplot(data=filter(a, PTEV != 1), aes(x=Day, y=Traumatic, col=PTES)) +
  stat_summary(fun.data = mean_se, geom="line") +
  stat_summary(fun.data = mean_se, geom="errorbar", alpha = 0.5) +
  #stat_summary(fun.data = mean_se, geom="point") +
  #geom_smooth(data=filter(a, Day > 0), aes(col=PTES, fill=PTES), 
  #            method = "lm") +
  facet_grid(PTEV ~ Gamma, labeller = label_both) +
  theme_pander() +
  ggtitle("Effect of PTE Congruency on Intrusion Probability")
  #scale_color_brewer(type='seq', palette = "Blues", direction=-1) +
  #scale_color_gradient() +
  #scale_color_viridis_d(option="C") +
  annotate("rect", xmin=-2, xmax=2, ymin=-Inf, ymax=Inf, fill="red", alpha=0.2)
```

And, again, here is the proportion of trajectories.

```{r}
S_patterns <- patterns %>%
  group_by(PTEV, Gamma, Trajectory, PTES) %>%
  summarize(Num=n() / 6) %>%
  mutate(Val=cumsum(Num))

ggplot(data=filter(S_patterns, PTEV != 1), aes(x=PTES, y=Num, fill=Trajectory)) +
  geom_bar(stat = "identity", position="stack", col="white") +
  facet_grid(PTEV ~ Gamma, labeller=label_both) +
  scale_fill_brewer(palette="Accent") +
  xlab("Congruency (PTES)") +
  ylab("Percentage of Trajectories") +  
  ggtitle("Percentage of Recovery Trajectories by Congruency") +
  geom_text(aes(label=percent(Num/100)),
            position=position_stack(vjust=0.5)) +
  theme_pander()
```

### Effects on Hippocampus Size

The neurobiological variable of interest in this simulation is the predicted hippocampus size. 

